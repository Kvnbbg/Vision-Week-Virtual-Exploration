const translations = {
  en: {
    brand: "Vision Week",
    heroTitle: "Consultation hub for the Vision Week family",
    heroSubtitle:
      "A secure, bilingual space to book consultations, explore experiences, and stay connected with the community.",
    ctaPrimary: "Enter the consultation hub",
    ctaSecondary: "See the landing page",
    indexTitle: "Quick access",
    indexSubtitle:
      "Choose an experience or learn more about what the family is building together.",
    exploreTitle: "Virtual exploration",
    exploreDesc: "Explore curated virtual journeys and vision week highlights.",
    mobilityTitle: "Mobility stories",
    mobilityDesc: "Discover adaptive cars and mobility showcases.",
    wellnessTitle: "Wellness studio",
    wellnessDesc: "Join wellness and gym sessions tailored to the community.",
    nbaTitle: "Athlete spotlight",
    nbaDesc: "Follow inspiring athlete collaborations and events.",
    authTitle: "Join the family",
    authSubtitle:
      "Create your secure account to participate in consultations and member-only content.",
    statusGuest: "Not connected yet",
    statusMember: "Connected as",
    registerTitle: "Register",
    loginTitle: "Sign in",
    fullName: "Full name",
    email: "Email",
    password: "Password",
    registerButton: "Create account",
    loginButton: "Sign in",
    logoutButton: "Sign out",
    landingTitle: "A welcoming space for consultation and community",
    landingSubtitle:
      "Switch languages instantly, sign up securely, and navigate every experience with ease.",
    landingCta: "View the consultation index",
    landingHighlight: "Bilingual • Secure • Family-first",
    whiteoutBadge: "Whiteout braking display",
    whiteoutTitle: "Adaptive braking for every journey",
    whiteoutSubtitle:
      "Simulate braking readiness, calibrate the system, and preview safer stopping distances for families on the move.",
    whiteoutModeLabel: "Braking mode",
    whiteoutModeDesc:
      "Switch between presets to understand how the braking system behaves in changing conditions.",
    whiteoutModes: {
      urban: {
        name: "Urban calm",
        detail: "Slow speed optimization with extra pedestrian awareness and smooth deceleration."
      },
      highway: {
        name: "Highway control",
        detail: "Long-range scanning with dynamic pressure to keep confidence at higher speeds."
      },
      night: {
        name: "Night clarity",
        detail: "Enhanced light sensing with added stopping buffer for low-visibility routes."
      }
    },
    whiteoutRangeLabel: "Estimated travel speed",
    whiteoutRangeHint: "Adjust the slider to estimate the braking distance.",
    whiteoutDistanceLabel: "Estimated stopping distance",
    whiteoutSpeedLabel: "Speed",
    whiteoutReadyTitle: "Daily readiness check",
    whiteoutReadyDesc:
      "Keep the consultation fleet prepared with a live check-in and a gentle safety pulse.",
    whiteoutModeUrban: "Urban",
    whiteoutModeHighway: "Highway",
    whiteoutModeNight: "Night",
    whiteoutCalibrate: "Calibrate now",
    whiteoutCalibrated: "Calibration in progress…",
    whiteoutCalibratedDone: "Calibration complete",
    commerceBadge: "Commerce cockpit",
    commerceTitle: "Payment-ready commerce for the Vision Week family",
    commerceSubtitle:
      "Build transparent payment flows with automated totals, smart bundles, and clear checkout steps.",
    commerceTotalLabel: "Estimated total",
    commerceTotalNote: "Taxes and localized fees are calculated at checkout.",
    commercePlansTitle: "Experience bundles",
    commercePaymentTitle: "Payment setup",
    commerceQuantity: "Seats",
    commerceCta: "Proceed to secure checkout",
    commerceInvoice: "Generate invoice",
    commerceAutomationTitle: "Automated operations",
    commerceMonthly: "Monthly",
    commerceAnnual: "Annual",
    commercePerSeat: "per seat",
    systemsBadge: "System atlas",
    systemsTitle: "Different systems, atmospheres, and ozone profiles",
    systemsSubtitle:
      "Translate planetary data into immersive experiences with climate, ozone strength, and sky color cues.",
    systemsHelper:
      "Each profile is structured for quick API or dataset integration and can map to the repositories provided.",
    systemsAtmosphereLabel: "Atmosphere",
    systemsOzoneLabel: "Ozone characteristics",
    systemsSkyLabel: "Sky tone",
    systemsMoonsLabel: "Moons & satellites",
    systemsNotesLabel: "Simulation notes"
  },
  fr: {
    brand: "Semaine de la Vision",
    heroTitle: "Le hub de consultation pour la famille Vision Week",
    heroSubtitle:
      "Un espace sécurisé et bilingue pour réserver des consultations, explorer des expériences et rester connecté à la communauté.",
    ctaPrimary: "Accéder au hub de consultation",
    ctaSecondary: "Voir la page d'accueil",
    indexTitle: "Accès rapide",
    indexSubtitle:
      "Choisissez une expérience ou découvrez ce que la famille construit ensemble.",
    exploreTitle: "Exploration virtuelle",
    exploreDesc: "Explorez des parcours virtuels et les moments forts de Vision Week.",
    mobilityTitle: "Histoires de mobilité",
    mobilityDesc: "Découvrez les voitures adaptées et les initiatives mobilité.",
    wellnessTitle: "Studio bien-être",
    wellnessDesc: "Rejoignez des sessions gym et bien-être dédiées à la communauté.",
    nbaTitle: "Focus athlète",
    nbaDesc: "Suivez des collaborations et événements inspirants.",
    authTitle: "Rejoindre la famille",
    authSubtitle:
      "Créez votre compte sécurisé pour participer aux consultations et aux contenus réservés.",
    statusGuest: "Pas encore connecté",
    statusMember: "Connecté en tant que",
    registerTitle: "Inscription",
    loginTitle: "Connexion",
    fullName: "Nom complet",
    email: "Email",
    password: "Mot de passe",
    registerButton: "Créer un compte",
    loginButton: "Se connecter",
    logoutButton: "Se déconnecter",
    landingTitle: "Un espace accueillant pour la consultation et la communauté",
    landingSubtitle:
      "Changez de langue instantanément, inscrivez-vous en toute sécurité et naviguez facilement.",
    landingCta: "Voir l'index des consultations",
    landingHighlight: "Bilingue • Sécurisé • Famille d'abord",
    whiteoutBadge: "Affichage du freinage Whiteout",
    whiteoutTitle: "Freinage adaptatif pour chaque trajet",
    whiteoutSubtitle:
      "Simulez la préparation du freinage, calibrez le système et anticipez des distances d'arrêt plus sûres.",
    whiteoutModeLabel: "Mode de freinage",
    whiteoutModeDesc:
      "Basculez entre les préréglages pour comprendre le comportement du freinage selon les conditions.",
    whiteoutModes: {
      urban: {
        name: "Calme urbain",
        detail: "Optimisation à basse vitesse avec attention piétonne et décélération douce."
      },
      highway: {
        name: "Contrôle autoroute",
        detail: "Analyse longue portée et pression dynamique pour les vitesses élevées."
      },
      night: {
        name: "Clarté nocturne",
        detail: "Capteurs renforcés et marge d'arrêt pour faible visibilité."
      }
    },
    whiteoutRangeLabel: "Vitesse estimée",
    whiteoutRangeHint: "Ajustez le curseur pour estimer la distance d'arrêt.",
    whiteoutDistanceLabel: "Distance d'arrêt estimée",
    whiteoutSpeedLabel: "Vitesse",
    whiteoutReadyTitle: "Vérification quotidienne",
    whiteoutReadyDesc:
      "Gardez la flotte prête avec un check-in en direct et une impulsion de sécurité.",
    whiteoutModeUrban: "Urbain",
    whiteoutModeHighway: "Autoroute",
    whiteoutModeNight: "Nuit",
    whiteoutCalibrate: "Calibrer maintenant",
    whiteoutCalibrated: "Calibration en cours…",
    whiteoutCalibratedDone: "Calibration terminée",
    commerceBadge: "Poste commerce",
    commerceTitle: "Commerce prêt au paiement pour la famille Vision Week",
    commerceSubtitle:
      "Créez des flux de paiement transparents avec totaux automatisés, offres intelligentes et étapes claires.",
    commerceTotalLabel: "Total estimé",
    commerceTotalNote: "Taxes et frais locaux calculés au moment du paiement.",
    commercePlansTitle: "Bundles d'expérience",
    commercePaymentTitle: "Configuration de paiement",
    commerceQuantity: "Places",
    commerceCta: "Continuer vers le paiement sécurisé",
    commerceInvoice: "Générer une facture",
    commerceAutomationTitle: "Opérations automatisées",
    commerceMonthly: "Mensuel",
    commerceAnnual: "Annuel",
    commercePerSeat: "par place",
    systemsBadge: "Atlas des systèmes",
    systemsTitle: "Différents systèmes, atmosphères et profils d'ozone",
    systemsSubtitle:
      "Transformez les données planétaires en expériences immersives avec climat, ozone et teintes du ciel.",
    systemsHelper:
      "Chaque profil est structuré pour une intégration rapide API ou dataset et s'aligne avec les dépôts fournis.",
    systemsAtmosphereLabel: "Atmosphère",
    systemsOzoneLabel: "Caractéristiques d'ozone",
    systemsSkyLabel: "Teinte du ciel",
    systemsMoonsLabel: "Lunes et satellites",
    systemsNotesLabel: "Notes de simulation"
  }
};

const $ = (selector, scope = document) => scope.querySelector(selector);
const $$ = (selector, scope = document) => Array.from(scope.querySelectorAll(selector));

const languageButtons = $$('[data-language]');
const themeToggle = $('[data-theme-toggle]');
const animatedItems = $$('[data-animate]');
const whiteoutModeButtons = $$('[data-whiteout-mode]');
const whiteoutModeDetails = $('[data-whiteout-details]');
const brakingRange = $('[data-braking-range]');
const brakingSpeed = $('[data-braking-speed]');
const brakingDistance = $('[data-braking-distance]');
const calibrateButton = $('[data-whiteout-calibrate]');
const calibrateStatus = $('[data-whiteout-status]');
const commercePlansContainer = $('[data-commerce-plans]');
const commerceCycleContainer = $('[data-commerce-cycle]');
const commerceMethodsContainer = $('[data-commerce-methods]');
const commerceAutomationList = $('[data-commerce-automation]');
const commerceTotal = $('[data-commerce-total]');
const quantityInput = $('#commerceQuantity');
const quantityMinus = $('[data-quantity-minus]');
const quantityPlus = $('[data-quantity-plus]');
const systemCardsContainer = $('[data-system-cards]');
let currentLanguage = 'en';

function applyLanguage(lang) {
  const dictionary = translations[lang] || translations.en;
  currentLanguage = lang;
  document.documentElement.lang = lang;
  $$('[data-i18n]').forEach((el) => {
    const key = el.getAttribute('data-i18n');
    if (dictionary[key]) {
      el.textContent = dictionary[key];
    }
  });
  languageButtons.forEach((button) => {
    button.setAttribute('aria-pressed', button.dataset.language === lang ? 'true' : 'false');
  });
  localStorage.setItem('preferredLanguage', lang);
  document.dispatchEvent(new CustomEvent('languagechange', { detail: { lang } }));
}

function applyTheme(theme) {
  if (theme === 'dark') {
    document.body.classList.add('dark-mode');
  } else {
    document.body.classList.remove('dark-mode');
  }
  if (themeToggle) {
    themeToggle.setAttribute('aria-pressed', theme === 'dark');
  }
  localStorage.setItem('preferredTheme', theme);
}

function toggleTheme() {
  const current = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
  applyTheme(current === 'dark' ? 'light' : 'dark');
}

languageButtons.forEach((button) => {
  button.addEventListener('click', () => applyLanguage(button.dataset.language));
});

if (themeToggle) {
  themeToggle.addEventListener('click', toggleTheme);
}

const savedLanguage = localStorage.getItem('preferredLanguage') || 'en';
const savedTheme = localStorage.getItem('preferredTheme') || 'light';
applyLanguage(savedLanguage);
applyTheme(savedTheme);

const intersectionObserver =
  animatedItems.length > 0
    ? new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add('is-visible');
              intersectionObserver.unobserve(entry.target);
            }
          });
        },
        { threshold: 0.2 }
      )
    : null;

animatedItems.forEach((item) => intersectionObserver?.observe(item));

const updateWhiteoutMode = (mode) => {
  const dictionary = translations[currentLanguage] || translations.en;
  const modeData = dictionary.whiteoutModes?.[mode];
  if (!modeData || !whiteoutModeDetails) return;
  whiteoutModeDetails.querySelector('[data-whiteout-mode-name]').textContent = modeData.name;
  whiteoutModeDetails.querySelector('[data-whiteout-mode-detail]').textContent = modeData.detail;
  whiteoutModeButtons.forEach((button) => {
    button.setAttribute('aria-pressed', button.dataset.whiteoutMode === mode ? 'true' : 'false');
  });
};

const updateBrakingDistance = () => {
  if (!brakingRange || !brakingSpeed || !brakingDistance) return;
  const speed = Number(brakingRange.value);
  const distance = Math.round(speed * 0.75);
  brakingSpeed.textContent = `${speed} km/h`;
  brakingDistance.textContent = `${distance} m`;
};

const localeConfig = {
  en: { locale: 'en-US', currency: 'USD' },
  fr: { locale: 'fr-FR', currency: 'EUR' }
};

const commercePlans = [
  {
    id: 'consult',
    name: { en: 'Consultation Essentials', fr: 'Essentiels consultation' },
    description: {
      en: 'Ideal for families booking weekly sessions and secure chat follow-ups.',
      fr: 'Idéal pour réserver des sessions hebdo et assurer un suivi sécurisé.'
    },
    pricing: { monthly: 45, annual: 450 },
    features: {
      en: ['Weekly consultation slots', 'Secure family chat', 'Instant itinerary updates'],
      fr: ['Créneaux hebdomadaires', 'Chat familial sécurisé', "Mises à jour d'itinéraire"]
    }
  },
  {
    id: 'explore',
    name: { en: 'Exploration Premium', fr: 'Exploration premium' },
    description: {
      en: 'Unlock deep-dive experiences with curated guides and virtual tours.',
      fr: 'Débloquez des expériences approfondies avec guides et visites virtuelles.'
    },
    pricing: { monthly: 85, annual: 850 },
    features: {
      en: ['Live guide rooms', 'Priority event access', 'Multi-language recaps'],
      fr: ['Salles de guide en direct', 'Accès prioritaire', 'Récaps multilingues']
    }
  },
  {
    id: 'enterprise',
    name: { en: 'Community Impact', fr: 'Impact communautaire' },
    description: {
      en: 'Designed for sponsors supporting multiple families and outreach.',
      fr: 'Pensé pour les sponsors soutenant plusieurs familles.'
    },
    pricing: { monthly: 150, annual: 1500 },
    features: {
      en: ['Sponsored seats', 'Impact reporting', 'Dedicated concierge'],
      fr: ['Places sponsorisées', "Rapports d'impact", 'Conciergerie dédiée']
    }
  }
];

const billingCycles = [
  { id: 'monthly', labelKey: 'commerceMonthly' },
  { id: 'annual', labelKey: 'commerceAnnual' }
];

const paymentMethods = [
  {
    id: 'card',
    name: { en: 'Card · Visa / MasterCard', fr: 'Carte · Visa / MasterCard' },
    detail: { en: 'Instant confirmation and receipts.', fr: 'Confirmation instantanée et reçus.' }
  },
  {
    id: 'transfer',
    name: { en: 'Bank transfer', fr: 'Virement bancaire' },
    detail: { en: 'Ideal for sponsor disbursements.', fr: 'Idéal pour les sponsors.' }
  },
  {
    id: 'wallet',
    name: { en: 'Digital wallet', fr: 'Portefeuille numérique' },
    detail: { en: 'Fast checkout with stored preferences.', fr: 'Paiement rapide avec préférences.' }
  }
];

const automationTasks = [
  {
    en: 'Auto-issue receipts and email confirmations.',
    fr: 'Émission automatique des reçus et confirmations.'
  },
  {
    en: 'Sync commerce data with consultation schedules.',
    fr: 'Synchronisation des paiements avec les plannings.'
  },
  {
    en: 'Trigger renewal reminders 7 days before billing.',
    fr: 'Rappels de renouvellement 7 jours avant facturation.'
  }
];

const systemProfiles = [
  {
    name: { en: 'Aurora Ridge', fr: 'Crête Aurora' },
    atmosphere: { en: 'Nitrogen-oxygen blend with icy particulates', fr: "Mélange azote-oxygène et particules glacées" },
    ozone: { en: 'High ozone shield, strong UV filtering', fr: "Bouclier d'ozone élevé, filtrage UV fort" },
    sky: { en: 'Electric teal with polar ribbons', fr: 'Teal électrique avec rubans polaires' },
    moons: { en: '2 icy moons, reflective albedo', fr: '2 lunes glacées, albédo réfléchissant' },
    notes: {
      en: 'Recommended for calm, high-visibility exploration routes.',
      fr: 'Recommandé pour des trajets calmes et très visibles.'
    },
    tags: ['O₂-rich', 'Polar', 'Calm']
  },
  {
    name: { en: 'Saffron Drift', fr: 'Dérive safran' },
    atmosphere: { en: 'CO₂-rich with sulfur haze', fr: 'Riche en CO₂ avec brume soufrée' },
    ozone: { en: 'Thin ozone layer, high UV exposure', fr: "Couche d'ozone fine, forte exposition UV" },
    sky: { en: 'Amber-orange with low-lying clouds', fr: 'Orange ambré avec nuages bas' },
    moons: { en: 'Dusty ringlets and 1 inner moon', fr: 'Anneaux poussiéreux et 1 lune interne' },
    notes: {
      en: 'Use cautionary lighting and UV-aware gear in simulations.',
      fr: 'Prévoir un éclairage prudent et des protections UV.'
    },
    tags: ['CO₂', 'Haze', 'High UV']
  },
  {
    name: { en: 'Verdant Halo', fr: 'Halo verdoyant' },
    atmosphere: { en: 'Dense oxygen-methane mix', fr: 'Mélange dense oxygène-méthane' },
    ozone: { en: 'Moderate ozone, fluctuating bands', fr: "Ozone modéré, bandes fluctuantes" },
    sky: { en: 'Emerald gradients with mist', fr: 'Dégradés émeraude et brume' },
    moons: { en: '3 satellites, tidal shimmer events', fr: '3 satellites, marées lumineuses' },
    notes: {
      en: 'Ideal for layered ambiance and bioluminescent cues.',
      fr: 'Idéal pour une ambiance en couches et bioluminescente.'
    },
    tags: ['Bioluminescent', 'Tidal', 'Dense']
  }
];

const commerceState = {
  planId: commercePlans[0]?.id,
  cycle: billingCycles[0]?.id,
  quantity: 1,
  methodId: paymentMethods[0]?.id
};

const getLocalizedValue = (value) => {
  if (typeof value === 'string') return value;
  return value?.[currentLanguage] ?? value?.en ?? '';
};

const formatCurrency = (amount) => {
  const config = localeConfig[currentLanguage] || localeConfig.en;
  return new Intl.NumberFormat(config.locale, {
    style: 'currency',
    currency: config.currency,
    maximumFractionDigits: 0
  }).format(amount);
};

const clampQuantity = (value) => Math.min(20, Math.max(1, value));

const getSelectedPlan = () => commercePlans.find((plan) => plan.id === commerceState.planId) || commercePlans[0];

const updateCommerceTotal = () => {
  if (!commerceTotal) return;
  const plan = getSelectedPlan();
  const planPrice = plan?.pricing?.[commerceState.cycle] || 0;
  const total = planPrice * commerceState.quantity;
  commerceTotal.textContent = formatCurrency(total);
};

const renderBillingCycles = () => {
  if (!commerceCycleContainer) return;
  commerceCycleContainer.innerHTML = '';
  billingCycles.forEach((cycle) => {
    const button = document.createElement('button');
    button.type = 'button';
    button.textContent = translations[currentLanguage]?.[cycle.labelKey] || cycle.id;
    if (commerceState.cycle === cycle.id) {
      button.classList.add('is-active');
    }
    button.addEventListener('click', () => {
      commerceState.cycle = cycle.id;
      renderCommerceSection();
    });
    commerceCycleContainer.appendChild(button);
  });
};

const renderPlans = () => {
  if (!commercePlansContainer) return;
  commercePlansContainer.innerHTML = '';
  commercePlans.forEach((plan) => {
    const card = document.createElement('div');
    card.className = 'plan-card';
    if (commerceState.planId === plan.id) {
      card.classList.add('is-selected');
    }
    card.innerHTML = `
      <h4>${getLocalizedValue(plan.name)}</h4>
      <p class="notice">${getLocalizedValue(plan.description)}</p>
      <strong>${formatCurrency(plan.pricing[commerceState.cycle])}</strong>
      <span class="label">${translations[currentLanguage].commercePerSeat}</span>
      <ul class="plan-features">
        ${getLocalizedValue(plan.features)
          .map((feature) => `<li>${feature}</li>`)
          .join('')}
      </ul>
    `;
    card.addEventListener('click', () => {
      commerceState.planId = plan.id;
      renderCommerceSection();
    });
    commercePlansContainer.appendChild(card);
  });
};

const renderPaymentMethods = () => {
  if (!commerceMethodsContainer) return;
  commerceMethodsContainer.innerHTML = '';
  paymentMethods.forEach((method) => {
    const option = document.createElement('div');
    option.className = 'payment-option';
    if (commerceState.methodId === method.id) {
      option.classList.add('is-selected');
    }
    option.innerHTML = `
      <div>
        <strong>${getLocalizedValue(method.name)}</strong>
        <p class="notice">${getLocalizedValue(method.detail)}</p>
      </div>
      <span>${commerceState.methodId === method.id ? '✓' : ''}</span>
    `;
    option.addEventListener('click', () => {
      commerceState.methodId = method.id;
      renderCommerceSection();
    });
    commerceMethodsContainer.appendChild(option);
  });
};

const renderAutomationTasks = () => {
  if (!commerceAutomationList) return;
  commerceAutomationList.innerHTML = automationTasks
    .map((task) => `<li>${getLocalizedValue(task)}</li>`)
    .join('');
};

const renderSystems = () => {
  if (!systemCardsContainer) return;
  systemCardsContainer.innerHTML = '';
  systemProfiles.forEach((profile) => {
    const card = document.createElement('div');
    card.className = 'system-card';
    const tags = profile.tags
      .map((tag) => `<span class="system-tag">${tag}</span>`)
      .join('');
    card.innerHTML = `
      <h3>${getLocalizedValue(profile.name)}</h3>
      <div class="system-meta">
        <div><strong>${translations[currentLanguage].systemsAtmosphereLabel}:</strong> ${getLocalizedValue(
          profile.atmosphere
        )}</div>
        <div><strong>${translations[currentLanguage].systemsOzoneLabel}:</strong> ${getLocalizedValue(
          profile.ozone
        )}</div>
        <div><strong>${translations[currentLanguage].systemsSkyLabel}:</strong> ${getLocalizedValue(profile.sky)}</div>
        <div><strong>${translations[currentLanguage].systemsMoonsLabel}:</strong> ${getLocalizedValue(
          profile.moons
        )}</div>
      </div>
      <p class="notice"><strong>${translations[currentLanguage].systemsNotesLabel}:</strong> ${getLocalizedValue(
        profile.notes
      )}</p>
      <div class="system-tags">${tags}</div>
    `;
    systemCardsContainer.appendChild(card);
  });
};

const renderCommerceSection = () => {
  renderBillingCycles();
  renderPlans();
  renderPaymentMethods();
  renderAutomationTasks();
  updateCommerceTotal();
  if (quantityInput) {
    quantityInput.value = commerceState.quantity;
  }
};

whiteoutModeButtons.forEach((button) => {
  button.addEventListener('click', () => updateWhiteoutMode(button.dataset.whiteoutMode));
});

if (brakingRange) {
  brakingRange.addEventListener('input', updateBrakingDistance);
  updateBrakingDistance();
}

if (calibrateButton && calibrateStatus) {
  calibrateButton.addEventListener('click', () => {
    const dictionary = translations[currentLanguage] || translations.en;
    calibrateStatus.textContent = dictionary.whiteoutCalibrated;
    calibrateStatus.classList.add('is-active');
    calibrateButton.disabled = true;
    setTimeout(() => {
      calibrateStatus.textContent = dictionary.whiteoutCalibratedDone;
      calibrateButton.disabled = false;
    }, 1800);
  });
}

if (quantityInput) {
  quantityInput.addEventListener('input', () => {
    commerceState.quantity = clampQuantity(Number(quantityInput.value) || 1);
    updateCommerceTotal();
    quantityInput.value = commerceState.quantity;
  });
}

if (quantityMinus) {
  quantityMinus.addEventListener('click', () => {
    commerceState.quantity = clampQuantity(commerceState.quantity - 1);
    updateCommerceTotal();
    if (quantityInput) quantityInput.value = commerceState.quantity;
  });
}

if (quantityPlus) {
  quantityPlus.addEventListener('click', () => {
    commerceState.quantity = clampQuantity(commerceState.quantity + 1);
    updateCommerceTotal();
    if (quantityInput) quantityInput.value = commerceState.quantity;
  });
}

document.addEventListener('languagechange', () => {
  updateWhiteoutMode(whiteoutModeButtons[0]?.dataset.whiteoutMode || 'urban');
  updateBrakingDistance();
  if (calibrateStatus) {
    const dictionary = translations[currentLanguage] || translations.en;
    calibrateStatus.textContent = dictionary.whiteoutCalibrate;
  }
  renderCommerceSection();
  renderSystems();
});

updateWhiteoutMode(whiteoutModeButtons[0]?.dataset.whiteoutMode || 'urban');
renderCommerceSection();
renderSystems();
